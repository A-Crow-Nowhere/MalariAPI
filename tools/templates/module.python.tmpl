#!/usr/bin/env bash
# =========================================================
# MAPI COMMAND: {{NAME}}
# =========================================================
# Description:
#   {{DESCRIPTION}}
#
# Generated by: tools/ai/mapi_codegen.py
# =========================================================
set -euo pipefail

log(){ echo "[mapi {{NAME}}] $*"; }
die(){ echo "[mapi {{NAME}}] ERROR: $*" >&2; exit 2; }

# -----------------------------
# [1] Locate MAPI root
# -----------------------------
MAPI_ROOT="${MAPI_ROOT:-}"
if [[ -z "${MAPI_ROOT}" ]]; then
  # Infer from: <root>/bin/modules/{{NAME}}.sh
  _SELF="$(readlink -f "$0" 2>/dev/null || python3 -c 'import os,sys;print(os.path.realpath(sys.argv[1]))' "$0")"
  MAPI_ROOT="$(cd "$(dirname "$_SELF")/../.." && pwd)"
fi
log "MAPI_ROOT=$MAPI_ROOT"

ENV_NAME="{{NAME}}"
ENV_PREFIX="$MAPI_ROOT/envs/$ENV_NAME"
YML_SPEC="$MAPI_ROOT/modules/yaml/$ENV_NAME.yml"

# -----------------------------
# [2] Usage
# -----------------------------
usage() {
  cat <<'USAGE'
mapi {{NAME}} [options]

About:
  {{DESCRIPTION}}

Options:
{{USAGE_BLOCK}}

Notes:
  - Runs inside conda env: envs/{{NAME}}
  - If env missing, build it from: modules/yaml/{{NAME}}.yml

USAGE
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

# -----------------------------
# [3] Run
# -----------------------------
if [[ ! -d "$ENV_PREFIX" ]]; then
  die "Conda env not found at: $ENV_PREFIX  (build from: $YML_SPEC)"
fi

log "Using env: $ENV_PREFIX"
log "Entrypoint: {{ENTRYPOINT}}"
log "Args: $*"

# Resolve tool path (no shell-expansion issues)
REL_TOOL="{{REL_TOOL}}"
TOOL_PATH="$MAPI_ROOT/$REL_TOOL"

if [[ ! -e "$TOOL_PATH" ]]; then
  die "Tool path does not exist: $TOOL_PATH  (REL_TOOL=$REL_TOOL)"
fi

# Build argv explicitly (first arg is executable, second is tool path)
CMD_ARR=( {{CMD_EXE}} "$TOOL_PATH" )

log "Exec: conda run -p $ENV_PREFIX ${CMD_ARR[*]} $*"
exec conda run -p "$ENV_PREFIX" "${CMD_ARR[@]}" "$@"
