#!/usr/bin/env bash
set -Eeuo pipefail
[[ "${MAPI_DEBUG:-0}" == "1" ]] && set -x

# Resolve MAPI root (prefer env from mapi.env)
MAPI_ROOT="${MAPI_ROOT:-$(cd "$(dirname "$0")/../.." && pwd)}"
cd "$MAPI_ROOT"

echo "[git-upload] MAPI_ROOT=$MAPI_ROOT"
echo "[git-upload] repo: $(git rev-parse --show-toplevel 2>/dev/null || echo 'NOT A GIT REPO')"

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "[git-upload] ERROR: $MAPI_ROOT is not a git repository."
  exit 1
fi

# One-time: set user.name / user.email from env if provided and not already set
if [[ -n "${GIT_USER_NAME:-}" ]]; then
  if ! git config user.name >/dev/null 2>&1; then
    echo "[git-upload] setting git user.name to '$GIT_USER_NAME'"
    git config user.name "$GIT_USER_NAME"
  fi
fi

if [[ -n "${GIT_USER_EMAIL:-}" ]]; then
  if ! git config user.email >/dev/null 2>&1; then
    echo "[git-upload] setting git user.email to '$GIT_USER_EMAIL'"
    git config user.email "$GIT_USER_EMAIL"
  fi
fi

# Commit message: either args -> message, or auto-generated
if [[ "$#" -gt 0 ]]; then
  COMMIT_MSG="$*"
else
  COMMIT_MSG="mapi: auto-commit $(date +'%Y-%m-%d %H:%M:%S')"
fi

echo "[git-upload] using commit message: '$COMMIT_MSG'"

# Make sure there is actually something to commit
CHANGES="$(git status --porcelain)"
if [[ -z "$CHANGES" ]]; then
  echo "[git-upload] nothing to commit; working tree clean."
  exit 0
fi

echo "[git-upload] changes to commit:"
echo "$CHANGES"

echo "[git-upload] staging all changes (git add -A)"
git add -A

# Double-check staged content; if nothing staged, bail
if git diff --cached --quiet; then
  echo "[git-upload] no staged changes after git add; aborting commit."
  exit 0
fi

echo "[git-upload] committing..."
git commit -m "$COMMIT_MSG"

echo "[git-upload] pushing (git push)..."
GIT_TERMINAL_PROMPT=1 git push

echo "[git-upload] done."
