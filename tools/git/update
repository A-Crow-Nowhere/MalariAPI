#!/usr/bin/env bash
set -Eeuo pipefail
[[ "${MAPI_DEBUG:-0}" == "1" ]] && set -x

# ------------------------------------------------------------
# Parse args
# ------------------------------------------------------------
VERSION_UPDATE=0

while (( "$#" )); do
  case "$1" in
    --version-update)
      VERSION_UPDATE=1
      shift
      ;;
    --help|-h)
      cat <<EOF
Usage: mapi git update [--version-update]

Without flags:
  - Uses the 'upstream' remote (whatever the user configured)
  - Fetches upstream/main
  - Merges into local main
  - Pushes to origin/main
  - Merges updated main into the current branch and pushes it (if tracked)

With --version-update:
  - Uses canonical MAPI remote (mapi-main), pointing to:
      \${MAPI_UPSTREAM_URL:-git@github.com:A-Crow-Nowhere/MalariAPI.git}
  - Same merge/push behavior as above, but always from canonical MAPI main.

EOF
      exit 0
      ;;
    *)
      echo "[git-update] unknown option: $1" >&2
      exit 1
      ;;
  esac
done

# ------------------------------------------------------------
# Resolve MAPI root
# ------------------------------------------------------------
MAPI_ROOT="${MAPI_ROOT:-$(cd "$(dirname "$0")/../.." && pwd)}"
cd "$MAPI_ROOT"

echo "[git-update] MAPI_ROOT=$MAPI_ROOT"
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "[git-update] ERROR: $MAPI_ROOT is not a git repository."
  exit 1
fi

# Remember the branch the user was on when they ran update
CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD)"
echo "[git-update] starting on branch: $CURRENT_BRANCH"

# ------------------------------------------------------------
# Decide which remote to use
# ------------------------------------------------------------
REMOTE_NAME=""
REMOTE_URL=""

if [[ "$VERSION_UPDATE" == "1" ]]; then
  # Canonical version update: always pull from your MAPI main
  REMOTE_NAME="mapi-main"
  REMOTE_URL="${MAPI_UPSTREAM_URL:-git@github.com:A-Crow-Nowhere/MalariAPI.git}"

  if ! git remote | grep -qx "$REMOTE_NAME"; then
    echo "[git-update] adding canonical remote '$REMOTE_NAME' -> $REMOTE_URL"
    git remote add "$REMOTE_NAME" "$REMOTE_URL"
  else
    echo "[git-update] using existing canonical remote '$REMOTE_NAME'"
  fi
else
  # Respect whatever the user set as upstream
  REMOTE_NAME="upstream"
  if ! git remote | grep -qx "$REMOTE_NAME"; then
    echo "[git-update] ERROR: no 'upstream' remote configured."
    echo "  Please either:"
    echo "    git remote add upstream git@github.com:YourUser/MalariAPI.git"
    echo "  or run:"
    echo "    mapi git update --version-update"
    exit 1
  fi
  echo "[git-update] using user-configured upstream remote '$REMOTE_NAME'"
fi

# ------------------------------------------------------------
# Fetch from chosen remote
# ------------------------------------------------------------
echo "[git-update] fetching from $REMOTE_NAME..."
git fetch "$REMOTE_NAME"

# ------------------------------------------------------------
# Update local main from REMOTE_NAME/main
# ------------------------------------------------------------
if git show-ref --verify --quiet refs/heads/main; then
  echo "[git-update] switching to main"
  git switch main

  echo "[git-update] merging $REMOTE_NAME/main into local main"
  if ! git merge --ff-only "$REMOTE_NAME/main"; then
    echo "[git-update] non-fast-forward; attempting normal merge"
    if ! git merge "$REMOTE_NAME/main"; then
      echo "[git-update] MERGE CONFLICTS in main."
      echo "  Please resolve conflicts in main, then run:"
      echo "    git commit"
      echo "    git push origin main"
      exit 1
    fi
  fi

  echo "[git-update] pushing updated main -> origin/main"
  git push origin main
else
  echo "[git-update] no local main branch; skipping main update"
fi

# ------------------------------------------------------------
# If user started on another branch, merge updated main into it
# ------------------------------------------------------------
if [[ "$CURRENT_BRANCH" != "main" ]]; then
  echo "[git-update] switching back to previous branch: $CURRENT_BRANCH"
  if ! git switch "$CURRENT_BRANCH"; then
    echo "[git-update] WARNING: could not switch back to $CURRENT_BRANCH"
    exit 0
  fi

  if git show-ref --verify --quiet refs/heads/main; then
    echo "[git-update] merging updated main into $CURRENT_BRANCH"
    if ! git merge main; then
      echo "[git-update] MERGE CONFLICTS in $CURRENT_BRANCH."
      echo "  Please resolve conflicts and commit manually."
      exit 1
    fi

    # Push if this branch has an upstream
    if git rev-parse --abbrev-ref '@{u}' >/dev/null 2>&1; then
      echo "[git-update] pushing updated $CURRENT_BRANCH to its upstream"
      git push
    else
      echo "[git-update] no upstream set for $CURRENT_BRANCH; not pushing automatically."
    fi
  fi
fi

echo "[git-update] done."
