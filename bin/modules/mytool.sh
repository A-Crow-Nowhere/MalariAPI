#!/usr/bin/env bash
# =========================================================
# MAPI MODULE: mytool
# =========================================================
# Description:
#   Auto-generated MAPI command for mytool
#
# Generated by: tools/ai/mapi_codegen.py
# Safe to edit. Regeneration should preserve your manual edits if you keep them
# outside the AUTOGEN block (see below).
# =========================================================
set -euo pipefail

log() { echo "[mapi mytool] $*"; }
die() { echo "[mapi mytool] ERROR: $*" >&2; exit 2; }

# -----------------------------
# [1] Locate MAPI root
# -----------------------------
MAPI_ROOT="${MAPI_ROOT:-}"
if [[ -z "${MAPI_ROOT}" ]]; then
  # Infer: <root>/modules/mytool/run
  _SELF="$(readlink -f "$0" 2>/dev/null || python3 -c 'import os,sys;print(os.path.realpath(sys.argv[1]))' "$0")"
  MAPI_ROOT="$(cd "$(dirname "$_SELF")/../.." && pwd)"
fi
log "MAPI_ROOT=$MAPI_ROOT"

ENV_NAME="mytool"
ENV_PREFIX="$MAPI_ROOT/envs/$ENV_NAME"
YML_SPEC="$MAPI_ROOT/tools/yaml/$ENV_NAME.yml"

# -----------------------------
# [2] Usage
# -----------------------------
usage() {
  cat <<'USAGE'
mapi mytool [options]

About:
  Auto-generated MAPI command for mytool

Options:
  (no auto-detected options; pass-through to underlying command)

Notes:
  - Runs inside conda env: envs/mytool
  - If env missing, build it from: tools/yaml/mytool.yml

USAGE
}

# -----------------------------
# [3] Parse args (pass-through)
# -----------------------------
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

# -----------------------------
# [4] Run
# -----------------------------
if [[ ! -d "$ENV_PREFIX" ]]; then
  die "Conda env not found at: $ENV_PREFIX  (build from: $YML_SPEC)"
fi

log "Using env: $ENV_PREFIX"
log "Entrypoint: bash {SCRIPT} "$@""
log "Args: $*"

CMD='bash {SCRIPT} "$@"'

# Use bash -lc so your conda-run + tool behavior matches MAPI conventions.
exec conda run -p "$ENV_PREFIX" bash -lc "$CMD"
