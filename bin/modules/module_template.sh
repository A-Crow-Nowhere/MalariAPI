#!/usr/bin/env bash
# MAPI_META_BEGIN
# NAME: example_module
# SUMMARY: One-line description of what this module accomplishes.
#
# ENV:
#   primary: default
#   fallback: default
#
# OUTPUTS:
#   # Multiple outputs are totally fine:
#   - key: mapiTool
#     ext: out
#     description: Main output generated by this module
#   - key: mapiTool_log
#     ext: log
#     description: Log file for this module
#
# OPTIONS:
#   # ===================== INPUTS =====================
#   - flag: --in
#     short: -1
#     env: IN1
#     required: true
#     description: Primary input file (e.g. R1 FASTQ / BAM)
#
#   - flag: --in2
#     short: -2
#     env: IN2
#     required: false
#     description: Secondary input (e.g. R2 FASTQ)
#
#   # ===================== OUTPUT CONTROL =====================
#   - flag: --out
#     short: -o
#     env: OUTDIR
#     required: false
#     description: Output directory (overrides MSF default if provided)
#
#   # ===================== PERFORMANCE / MISC =====================
#   - flag: --threads
#     short: -t
#     env: THREADS
#     default: 8
#     required: false
#     description: Number of threads to use
#
# RESOURCES:
#   # (optional docs / hints)
# MAPI_META_END

set -euo pipefail

# --------------------------- Identify module ---------------------------
self="$(basename "$0")"
mod="${self%.sh}"

# ---------------------------- Repo / metadata --------------------------
REPO_ROOT="${MAPI_REPO_ROOT:-"$(cd "$(dirname "$0")/../.." 2>/dev/null || pwd)"}"
meta="${MAPI_MODULE_YAML:-"$REPO_ROOT/bin/modules/yaml/$mod.yml"}"

if [[ ! -f "$meta" ]]; then
  echo "[warn] Missing metadata YAML (expected: $meta)" >&2
fi

# ---------------------- Load metadata/CLI helper -----------------------
# shellcheck disable=SC1090
source "$REPO_ROOT/bin/_mapi_meta.sh"

usage(){ cat <<EOF
Usage (standalone):
  $self --in <reads.fastq> [--in2 <reads2.fastq>] [--threads N] [--out <dir>] [-- ...]

Usage (via mapi, recommended):
  mapi modules $mod --in <reads.fastq> [--in2 <reads2.fastq>] [--threads N] ...

Notes:
  • Options and required inputs are defined in the MAPI_META header.
  • This script uses a shared parser that reads that header at runtime.

EOF
}

if [[ "${1-}" == "-h" || "${1-}" == "--help" ]]; then
  usage; exit 0
fi

# ---------------------- Tag / logical output key ----------------------
DEFAULT_TAG="${DEFAULT_TAG:-mapiTool}"   # must match OUTPUTS.key

# -------------------------- Resource checker ---------------------------
ensure_resources(){
  # Implement real checks here if needed.
  :
}

# ---------------------- Parse header & arguments -----------------------
mapi_meta_load "$0"
mapi_meta_parse_args "$@"

# At this point, from OPTIONS.env we have:
#   IN1, IN2, OUTDIR, THREADS (if present)
#   EXTRA[@] for unknown/extra args

# For safety, IN1 should be set due to required: true
if [[ -z "${IN1:-}" ]]; then
  echo "[error] IN1 is not set; check your --in option." >&2
  usage; exit 2
fi

# ------------------------ Name sample + OUTDIR -------------------------
bn="$(basename "$IN1")"
sample_prefix="${bn%%.*}"

OUTDIR="${OUTDIR:-${sample_prefix}_mapi-out}"
mkdir -p "$OUTDIR"

out_path(){ printf "%s/%s.%s.%s\n" "$OUTDIR" "$sample_prefix" "$DEFAULT_TAG" "$1"; }

# ------------------------- Resource enforcement ------------------------
ensure_resources

# --------------------------- Tool execution ----------------------------
# ${IN2:+-I "$IN2"} explanation:
#   - If IN2 is empty: expands to nothing
#   - If IN2 is set:   expands to: -I "$IN2"
# This lets us conditionally add a second input flag without a separate if-block.

echo "[$mod] meta=${meta:-none} IN1=$IN1 IN2=${IN2:-none} THREADS=${THREADS:-unset} OUTDIR=$OUTDIR TAG=$DEFAULT_TAG" \
  | tee "$(out_path log)"

echo "Example output for $mod" > "$(out_path out)"

# Example real tool call:
# tool_binary \
#   --threads "${THREADS:-1}" \
#   -i "$IN1" \
#   ${IN2:+-I "$IN2"} \
#   -o "$(out_path out)" \
#   "${EXTRA[@]}"
