#!/usr/bin/env bash
# =========================================================
# MAPI COMMAND: key_column
# =========================================================
# Description:
#   takes the sample key off of the front of a file name (eg samplekey.file.file.tsv), and adds a column at the end of the file (sample_name), and then populates all of the rows in that column with the samplekey
#
# Generated by: tools/ai/mapi_codegen.py
# =========================================================
set -euo pipefail

log(){ echo "[mapi key_column] $*"; }
die(){ echo "[mapi key_column] ERROR: $*" >&2; exit 2; }

# -----------------------------
# [1] Locate MAPI root
# -----------------------------
MAPI_ROOT="${MAPI_ROOT:-}"
if [[ -z "${MAPI_ROOT}" ]]; then
  # Infer from: <root>/bin/modules/key_column.sh
  _SELF="$(readlink -f "$0" 2>/dev/null || python3 -c 'import os,sys;print(os.path.realpath(sys.argv[1]))' "$0")"
  MAPI_ROOT="$(cd "$(dirname "$_SELF")/../.." && pwd)"
fi
log "MAPI_ROOT=$MAPI_ROOT"

ENV_NAME="key_column"
ENV_PREFIX="$MAPI_ROOT/envs/$ENV_NAME"
YML_SPEC="$MAPI_ROOT/modules/yaml/$ENV_NAME.yml"

# -----------------------------
# [2] Usage
# -----------------------------
usage() {
  cat <<'USAGE'
mapi key_column [options]

About:
  takes the sample key off of the front of a file name (eg samplekey.file.file.tsv), and adds a column at the end of the file (sample_name), and then populates all of the rows in that column with the samplekey

Options:
  (no auto-detected options; pass-through to underlying command)

Notes:
  - Runs inside conda env: envs/key_column
  - If env missing, build it from: modules/yaml/key_column.yml

USAGE
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

# -----------------------------
# [3] Run
# -----------------------------
if [[ ! -d "$ENV_PREFIX" ]]; then
  die "Conda env not found at: $ENV_PREFIX  (build from: $YML_SPEC)"
fi

log "Using env: $ENV_PREFIX"
log "Entrypoint: bash "$MAPI_ROOT/tools/generated/key_column/key_column.sh""
log "Args: $*"

# Resolve tool path (no shell-expansion issues)
REL_TOOL="tools/generated/key_column/key_column.sh"
TOOL_PATH="$MAPI_ROOT/$REL_TOOL"

if [[ ! -e "$TOOL_PATH" ]]; then
  die "Tool path does not exist: $TOOL_PATH  (REL_TOOL=$REL_TOOL)"
fi

# Build argv explicitly (first arg is executable, second is tool path)
CMD_ARR=( 'bash' "$TOOL_PATH" )

log "Exec: conda run -p $ENV_PREFIX ${CMD_ARR[*]} $*"
exec conda run -p "$ENV_PREFIX" "${CMD_ARR[@]}" "$@"
